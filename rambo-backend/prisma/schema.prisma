generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  DEVELOPER
  VIEWER
  AGENT
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
  ARCHIVED
}

enum WorkflowStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum AgentStatus {
  INACTIVE
  ACTIVE
  ERROR
  UPDATING
}

enum TicketType {
  BUG
  FEATURE
  IMPROVEMENT
  TASK
  EPIC
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  BLOCKED
}

enum RequirementType {
  FUNCTIONAL
  NON_FUNCTIONAL
  CONSTRAINT
  INTERFACE
  PERFORMANCE
}

enum RequirementStatus {
  DRAFT
  PROPOSED
  APPROVED
  IMPLEMENTED
  VERIFIED
  REJECTED
}

enum McpServerStatus {
  ACTIVE
  INACTIVE
  ERROR
  CONFIG_PENDING // If some setup is needed after registration
}

model User {
  id                String        @id @default(cuid())
  email             String        @unique
  password          String
  role              UserRole
  firstName         String?
  lastName          String?
  profilePictureUrl String?
  lastLogin         DateTime?
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  isDeleted         Boolean       @default(false)
  deletedAt         DateTime?
  
  projects          Project[]
  tasks             Task[]
  files             File[]
  assignedTickets   Ticket[]      @relation("AssignedTickets")
  reportedTickets   Ticket[]      @relation("ReportedTickets")
  requirements      Requirement[]

  @@map("users")
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([isDeleted])
}

model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  isDeleted   Boolean       @default(false)
  deletedAt   DateTime?
  owner       User          @relation(fields: [ownerId], references: [id])
  ownerId     String
  tasks       Task[]
  workflows   Workflow[]
  files       File[]
  tickets     Ticket[]
  requirements Requirement[]
  sprints     Sprint[]

  @@map("projects")
  @@index([ownerId])
  @@index([status])
  @@index([isDeleted])
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  priority    Int        @default(3)
  startDate   DateTime?
  dueDate     DateTime?
  estimatedHours Float?
  actualHours  Float?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  isDeleted   Boolean    @default(false)
  deletedAt   DateTime?
  project     Project    @relation(fields: [projectId], references: [id])
  projectId   String
  assignee    User?      @relation(fields: [assigneeId], references: [id])
  assigneeId  String?
  workflow    Workflow?  @relation(fields: [workflowId], references: [id])
  workflowId  String?
  agent       Agent?     @relation(fields: [agentId], references: [id])
  agentId     String?
  parentTask  Task?      @relation("SubTasks", fields: [parentId], references: [id])
  parentId    String?
  subTasks    Task[]     @relation("SubTasks")
  logs        TaskLog[]
  dependencies TaskDependency[] @relation("TaskDependencies")
  dependentTasks TaskDependency[] @relation("DependsOnTasks")
  // relatedRequirements Requirement[] @relation("RelatedTasks") // This was a mistake from previous schema example, removing

  @@map("tasks")
  @@index([projectId])
  @@index([assigneeId])
  @@index([workflowId])
  @@index([status])
  @@index([isDeleted])
  @@index([parentId])
}

model TaskDependency {
  id              String   @id @default(cuid())
  task            Task     @relation("TaskDependencies", fields: [taskId], references: [id])
  taskId          String
  dependsOnTask   Task     @relation("DependsOnTasks", fields: [dependsOnTaskId], references: [id]) // Corrected relation name here
  dependsOnTaskId String
  type            String   @default("FINISH_TO_START")  // Types like FS, SS, FF, SF
  createdAt       DateTime @default(now())

  @@unique([taskId, dependsOnTaskId])
  @@map("task_dependencies")
}

model Workflow {
  id          String         @id @default(cuid())
  name        String
  description String?
  status      WorkflowStatus @default(DRAFT)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  isDeleted   Boolean        @default(false)
  deletedAt   DateTime?
  project     Project        @relation(fields: [projectId], references: [id])
  projectId   String
  tasks       Task[]
  nodes       WorkflowNode[]
  edges       WorkflowEdge[]

  @@map("workflows")
  @@index([projectId])
  @@index([status])
  @@index([isDeleted])
}

model WorkflowNode {
  id        String   @id @default(cuid())
  name      String? // Added name field for better identification
  type      String
  config    Json
  workflow  Workflow @relation(fields: [workflowId], references: [id])
  workflowId String
  edgesOut  WorkflowEdge[] @relation("edgesOut")
  edgesIn   WorkflowEdge[] @relation("edgesIn")
  isTerminal Boolean @default(false) // Added to easily identify terminal nodes

  @@map("workflow_nodes")
}

model WorkflowEdge {
  id        String   @id @default(cuid())
  condition String?
  fromNode  WorkflowNode @relation("edgesOut", fields: [fromNodeId], references: [id])
  fromNodeId String
  toNode    WorkflowNode @relation("edgesIn", fields: [toNodeId], references: [id])
  toNodeId   String
  workflow  Workflow @relation(fields: [workflowId], references: [id])
  workflowId String

  @@map("workflow_edges")
}

model File {
  id        String   @id @default(cuid())
  name      String
  path      String
  size      Int
  type      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isDeleted Boolean  @default(false)
  deletedAt DateTime?
  project   Project? @relation(fields: [projectId], references: [id])
  projectId String?
  owner     User     @relation(fields: [ownerId], references: [id])
  ownerId   String
  // requirement Requirement? @relation("RequirementAttachments", fields: [requirementId], references: [id]) // This was a mistake
  // requirementId String? // This was a mistake

  @@map("files")
}

model TaskLog {
  id        String   @id @default(cuid())
  message   String
  level     String
  data      Json?
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id])
  taskId    String
  workflowExecutionId String? // Added to link to a specific workflow run
  workflowNodeId String? // Added to link to a specific node within a workflow run

  @@map("task_logs")
  @@index([workflowExecutionId])
}

model Agent {
  id          String       @id @default(cuid())
  name        String
  type        String       @unique // Agent types should be unique for lookup
  config      Json
  status      AgentStatus  @default(INACTIVE)
  lastPing    DateTime?
  capabilities String[]
  description String?
  version     String?
  isSystemAgent Boolean    @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  isDeleted   Boolean      @default(false)
  deletedAt   DateTime?
  tasks       Task[]
  logs        AgentLog[]

  @@map("agents")
  @@index([type])
  @@index([status])
  @@index([isDeleted])
  @@index([isSystemAgent])
}

model AgentLog {
  id        String   @id @default(cuid())
  message   String
  level     String
  data      Json?
  createdAt DateTime @default(now())
  agent     Agent    @relation(fields: [agentId], references: [id])
  agentId   String
  workflowExecutionId String? // Added to link to a specific workflow run
  workflowNodeId String? // Added to link to a specific node within a workflow run

  @@map("agent_logs")
  @@index([workflowExecutionId])
}

model Ticket {
  id          String          @id @default(cuid())
  title       String
  description String?
  type        TicketType
  priority    TicketPriority  @default(MEDIUM)
  status      TicketStatus    @default(BACKLOG)
  project     Project         @relation(fields: [projectId], references: [id])
  projectId   String
  assignee    User?           @relation("AssignedTickets", fields: [assigneeId], references: [id])
  assigneeId  String?
  reporter    User            @relation("ReportedTickets", fields: [reporterId], references: [id])
  reporterId  String
  sprint      Sprint?         @relation(fields: [sprintId], references: [id])
  sprintId    String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  closedAt    DateTime?
  estimatedHours Float?
  actualHours  Float?
  tags        String[]
  aiMetadata  Json?

  @@map("tickets")
  @@index([projectId])
  @@index([assigneeId])
  @@index([reporterId])
  @@index([sprintId])
  @@index([status])
}

model Requirement {
  id          String            @id @default(cuid())
  title       String
  description String
  type        RequirementType
  status      RequirementStatus @default(DRAFT)
  project     Project           @relation(fields: [projectId], references: [id])
  projectId   String
  source      String?
  priority    Int               @default(3)
  complexity  Int               @default(3)
  rationale   String?
  acceptance  String?
  createdBy   User              @relation(fields: [createdById], references: [id])
  createdById String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  version     String            @default("1.0")
  tags        String[]
  // relatedTasks Task[] @relation("RelatedRequirements") // This was from previous example, removed.
  // attachments File[] @relation("RequirementAttachments") // This was from previous example, removed.

  @@map("requirements")
  @@index([projectId])
  @@index([status])
  @@index([createdById])
}

model Sprint {
  id          String     @id @default(cuid())
  name        String
  goal        String?
  startDate   DateTime
  endDate     DateTime
  status      String     @default("PLANNED") // Consider enum SprintStatus
  project     Project    @relation(fields: [projectId], references: [id])
  projectId   String
  tickets     Ticket[]
  // tasks       Task[] // Sprints usually contain tickets, which can be broken into tasks. Direct task link might be redundant.
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("sprints")
  @@index([projectId])
  @@index([status])
}

model McpServer {
  id                String   @id @default(cuid())
  name              String   @unique // Human-readable unique name for the server
  description       String?
  baseUrl           String   // Base URL of the MCP server (e.g., http://localhost:8080/mcp)
  
  // protocolDetails will store specifics about how to communicate with this MCP server
  // e.g., version, specific paths, expected context structure, auth method if any
  protocolDetails   Json?    
  
  capabilities      String[] @default([]) // e.g., ["text_generation", "code_analysis", "image_classification"]
  
  status            McpServerStatus @default(ACTIVE)
  
  adminRegisteredAt DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastCheckedAt     DateTime? // Timestamp of the last health check or successful communication

  // Optional: Link to a user who registered it, if you have admin users managing these
  // registeredById String?
  // registeredBy   User?   @relation(fields: [registeredById], references: [id])
  isSystemServer    Boolean  @default(false)

  @@map("mcp_servers")
  @@index([name])
  @@index([status])
  @@index([isSystemServer])
}
